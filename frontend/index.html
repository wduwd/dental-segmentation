<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高校宿舍报修管理系统多问问多</title>
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus@2.4.4/dist/index.css">
    <!-- Vue 3 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.11/dist/vue.global.min.js"></script>
    <!-- Vue Router -->
    <script src="https://cdn.jsdelivr.net/npm/vue-router@4.2.5/dist/vue-router.global.min.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <!-- Element Plus JS -->
    <script src="https://cdn.jsdelivr.net/npm/element-plus@2.4.4/dist/index.full.min.js"></script>
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
        }
        #app {
            width: 100%;
            height: 100vh;
        }
        .el-main {
            padding: 20px;
        }
        .login-container {
            width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        .login-title {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .avatar-uploader {
            text-align: center;
        }
        .avatar-uploader .el-upload {
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: border-color 0.3s;
        }
        .avatar-uploader .el-upload:hover {
            border-color: #409eff;
        }
        .avatar-uploader-icon {
            font-size: 28px;
            color: #8c939d;
            width: 178px;
            height: 178px;
            line-height: 178px;
            text-align: center;
        }
        .avatar {
            width: 178px;
            height: 178px;
            display: block;
        }
    </style>
</head>
<body>
    <div id="app">
        <router-view></router-view>
    </div>

    <script>
        // 导入依赖
        const { createApp, ref, reactive, computed, onMounted } = Vue;
        const { createRouter, createWebHashHistory } = VueRouter;
        const { ElMessage, ElMessageBox } = ElementPlus;

        // 全局用户状态管理
        const userState = reactive({
            token: localStorage.getItem('token') || '',
            userInfo: JSON.parse(localStorage.getItem('userInfo')) || {},
            isLoggedIn: !!localStorage.getItem('token'),
            login(token, userInfo) {
                this.token = token;
                this.userInfo = userInfo;
                this.isLoggedIn = true;
                localStorage.setItem('token', token);
                localStorage.setItem('userInfo', JSON.stringify(userInfo));
            },
            logout() {
                this.token = '';
                this.userInfo = {};
                this.isLoggedIn = false;
                localStorage.removeItem('token');
                localStorage.removeItem('userInfo');
            }
        });

        // 将用户状态添加到全局可访问
        const useUserStore = () => userState;

        // Axios 配置
        axios.defaults.baseURL = 'http://localhost:5000/api';
        axios.interceptors.request.use(
            config => {
                const token = localStorage.getItem('token');
                if (token) {
                    config.headers.Authorization = `Bearer ${token}`;
                }
                return config;
            },
            error => {
                return Promise.reject(error);
            }
        );

        axios.interceptors.response.use(
            response => {
                return response;
            },
            error => {
                if (error.response && error.response.status === 401) {
                    ElMessage.error('登录已过期，请重新登录');
                    useUserStore().logout();
                    router.push('/login');
                }
                return Promise.reject(error);
            }
        );

        // 登录组件
        const Login = {
            template: `
                <div class="login-container">
                    <h2 class="login-title">高校宿舍报修管理系统</h2>
                    <el-form :model="loginForm" :rules="loginRules" ref="loginFormRef" label-width="80px">
                        <el-form-item label="账号" prop="username">
                            <el-input v-model="loginForm.username" placeholder="请输入学号/工号"></el-input>
                        </el-form-item>
                        <el-form-item label="密码" prop="password">
                            <el-input v-model="loginForm.password" type="password" placeholder="请输入密码" show-password></el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="handleLogin" style="width: 100%">登录</el-button>
                        </el-form-item>
                    </el-form>
                </div>
            `,
            setup() {
                const loginFormRef = ref(null);
                const loginForm = reactive({
                    username: '',
                    password: ''
                });
                const loginRules = {
                    username: [{ required: true, message: '请输入账号', trigger: 'blur' }],
                    password: [{ required: true, message: '请输入密码', trigger: 'blur' }]
                };

                const handleLogin = async () => {
                    try {
                        await loginFormRef.value.validate();
                        const response = await axios.post('/auth/login', loginForm);
                        if (response.data.code === 200) {
                            const { token, userInfo } = response.data.data;
                            useUserStore().login(token, userInfo);
                            ElMessage.success('登录成功');
                            router.push('/');
                        } else {
                            ElMessage.error(response.data.msg);
                        }
                    } catch (error) {
                        ElMessage.error('登录失败，请检查账号密码');
                    }
                };

                return {
                    loginFormRef,
                    loginForm,
                    loginRules,
                    handleLogin
                };
            }
        };

        // 主布局组件
        const Layout = {
            template: `
                <el-container>
                    <el-header style="background-color: #001529; color: white; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <el-avatar :size="40" :src="userStore.userInfo.avatar || ''"></el-avatar>
                            <span style="margin-left: 10px;">{{ userStore.userInfo.name }}</span>
                        </div>
                        <el-button type="text" @click="handleLogout" style="color: white;">退出登录</el-button>
                    </el-header>
                    <el-container>
                        <el-aside width="200px" style="background-color: #002140;">
                            <el-menu :default-active="activeMenu" class="el-menu-vertical-demo" background-color="#002140" text-color="white" active-text-color="#ffd04b">
                                <el-sub-menu index="1" v-if="userStore.userInfo.role === 'student'">
                                    <template #title>
                                        <span>报修功能</span>
                                    </template>
                                    <el-menu-item index="1-1" @click="$router.push('/repair')">在线报修</el-menu-item>
                                    <el-menu-item index="1-2" @click="$router.push('/my-repairs')">我的报修</el-menu-item>
                                </el-sub-menu>
                                <el-sub-menu index="2" v-if="userStore.userInfo.role === 'repairman'">
                                    <template #title>
                                        <span>维修管理</span>
                                    </template>
                                    <el-menu-item index="2-1" @click="$router.push('/repair-tasks')">任务列表</el-menu-item>
                                    <el-menu-item index="2-2" @click="$router.push('/repair-history')">历史记录</el-menu-item>
                                </el-sub-menu>
                                <el-sub-menu index="3" v-if="userStore.userInfo.role === 'admin'">
                                    <template #title>
                                        <span>系统管理</span>
                                    </template>
                                    <el-menu-item index="3-1" @click="$router.push('/admin/repair-management')">报修管理</el-menu-item>
                                    <el-menu-item index="3-2" @click="$router.push('/admin/user-management')">用户管理</el-menu-item>
                                    <el-menu-item index="3-3" @click="$router.push('/admin/data-dashboard')">数据统计</el-menu-item>
                                    <el-menu-item index="3-4" @click="$router.push('/admin/notice-management')">公告管理</el-menu-item>
                                </el-sub-menu>
                                <el-menu-item index="4" @click="$router.push('/profile')">
                                    <span>个人中心</span>
                                </el-menu-item>
                                <el-menu-item index="5" @click="$router.push('/notices')">
                                    <span>公告</span>
                                </el-menu-item>
                            </el-menu>
                        </el-aside>
                        <el-main>
                            <router-view></router-view>
                        </el-main>
                    </el-container>
                </el-container>
            `,
            setup() {
                const userStore = useUserStore();
                const activeMenu = ref('1');

                const handleLogout = () => {
                    ElMessageBox.confirm('确定要退出登录吗？', '退出登录', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        userStore.logout();
                        router.push('/login');
                        ElMessage.success('退出成功');
                    }).catch(() => {
                        // 取消退出
                    });
                };

                return {
                    userStore,
                    activeMenu,
                    handleLogout
                };
            }
        };

        // 首页组件
        const Home = {
            template: `
                <div>
                    <el-card>
                        <template #header>
                            <div class="card-header">
                                <span>欢迎使用高校宿舍报修管理系统</span>
                            </div>
                        </template>
                        <div v-if="userStore.userInfo.role === 'student'">
                            <h3>学生功能</h3>
                            <ul>
                                <li>在线提交报修申请</li>
                                <li>查看报修进度</li>
                                <li>对维修服务进行评价</li>
                            </ul>
                        </div>
                        <div v-else-if="userStore.userInfo.role === 'repairman'">
                            <h3>维修人员功能</h3>
                            <ul>
                                <li>接收维修任务</li>
                                <li>更新维修状态</li>
                                <li>查看历史维修记录</li>
                            </ul>
                        </div>
                        <div v-else-if="userStore.userInfo.role === 'admin'">
                            <h3>管理员功能</h3>
                            <ul>
                                <li>管理报修申请</li>
                                <li>管理用户信息</li>
                                <li>查看数据统计</li>
                                <li>发布公告</li>
                            </ul>
                        </div>
                    </el-card>
                </div>
            `,
            setup() {
                const userStore = useUserStore();
                return {
                    userStore
                };
            }
        };

        // 数据可视化组件
        const DataDashboard = {
            template: `
                <div>
                    <el-card>
                        <template #header>
                            <div class="card-header">
                                <span>数据统计看板</span>
                            </div>
                        </template>
                        
                        <div class="dashboard-container">
                            <!-- 报修量趋势图 -->
                            <div class="chart-item">
                                <h3>最近7天报修量趋势</h3>
                                <div ref="trendChart" style="width: 100%; height: 300px;"></div>
                            </div>
                            
                            <!-- 故障类型占比 -->
                            <div class="chart-item">
                                <h3>故障类型占比</h3>
                                <div ref="pieChart" style="width: 100%; height: 300px;"></div>
                            </div>
                            
                            <!-- 楼栋报修排名 -->
                            <div class="chart-item">
                                <h3>楼栋报修排名</h3>
                                <div ref="barChart" style="width: 100%; height: 300px;"></div>
                            </div>
                        </div>
                    </el-card>
                </div>
            `,
            setup() {
                const trendChart = ref(null);
                const pieChart = ref(null);
                const barChart = ref(null);
                
                onMounted(() => {
                    // 初始化图表
                    initTrendChart();
                    initPieChart();
                    initBarChart();
                });
                
                const initTrendChart = () => {
                    const chart = echarts.init(trendChart.value);
                    const option = {
                        tooltip: {
                            trigger: 'axis'
                        },
                        xAxis: {
                            type: 'category',
                            data: ['1月1日', '1月2日', '1月3日', '1月4日', '1月5日', '1月6日', '1月7日']
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [{
                            data: [12, 23, 15, 28, 35, 20, 18],
                            type: 'line',
                            smooth: true
                        }]
                    };
                    chart.setOption(option);
                };
                
                const initPieChart = () => {
                    const chart = echarts.init(pieChart.value);
                    const option = {
                        tooltip: {
                            trigger: 'item'
                        },
                        legend: {
                            orient: 'vertical',
                            left: 'left'
                        },
                        series: [{
                            name: '故障类型',
                            type: 'pie',
                            radius: '50%',
                            data: [
                                { value: 40, name: '水电' },
                                { value: 25, name: '家具' },
                                { value: 20, name: '门窗' },
                                { value: 10, name: '网络' },
                                { value: 5, name: '其他' }
                            ],
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }]
                    };
                    chart.setOption(option);
                };
                
                const initBarChart = () => {
                    const chart = echarts.init(barChart.value);
                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            }
                        },
                        xAxis: {
                            type: 'category',
                            data: ['1号楼', '2号楼', '3号楼', '4号楼', '5号楼', '6号楼']
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [{
                            data: [32, 45, 28, 52, 38, 20],
                            type: 'bar'
                        }]
                    };
                    chart.setOption(option);
                };
                
                return {
                    trendChart,
                    pieChart,
                    barChart
                };
            }
        };

        // 在线报修组件
        const Repair = {
            template: `
                <div>
                    <el-card>
                        <template #header>
                            <div class="card-header">
                                <span>在线报修</span>
                            </div>
                        </template>
                        <el-form :model="repairForm" :rules="repairRules" ref="repairFormRef" label-width="100px">
                            <el-form-item label="故障类型" prop="category">
                                <el-select v-model="repairForm.category" placeholder="请选择故障类型">
                                    <el-option label="水电" value="water_electricity"></el-option>
                                    <el-option label="家具" value="furniture"></el-option>
                                    <el-option label="门窗" value="doors_windows"></el-option>
                                    <el-option label="其他" value="other"></el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="宿舍信息" prop="room">
                                <el-input v-model="repairForm.room" placeholder="请输入宿舍楼号/房间号，如：1号楼301"></el-input>
                            </el-form-item>
                            <el-form-item label="故障描述" prop="description">
                                <el-input v-model="repairForm.description" type="textarea" :rows="4" placeholder="请详细描述故障情况"></el-input>
                            </el-form-item>
                            <el-form-item label="预约时间" prop="appointment_time">
                                <el-date-picker
                                    v-model="repairForm.appointment_time"
                                    type="datetime"
                                    placeholder="选择预约时间"
                                    format="YYYY-MM-DD HH:mm"
                                    value-format="YYYY-MM-DD HH:mm"
                                ></el-date-picker>
                            </el-form-item>
                            <el-form-item label="故障图片">
                                <el-upload
                                    class="avatar-uploader"
                                    action="#"
                                    :http-request="handleImageUpload"
                                    :show-file-list="true"
                                    :on-success="handleUploadSuccess"
                                    :on-error="handleUploadError"
                                    accept="image/*"
                                    :auto-upload="true"
                                >
                                    <img v-if="imageUrl" :src="imageUrl" class="avatar" />
                                    <span class="avatar-uploader-icon">+ 上传图片</span>
                                </el-upload>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="handleSubmit">提交报修</el-button>
                                <el-button @click="resetForm">重置</el-button>
                            </el-form-item>
                        </el-form>
                    </el-card>
                </div>
            `,
            setup() {
                const repairFormRef = ref(null);
                const repairForm = reactive({
                    category: '',
                    room: '',
                    description: '',
                    appointment_time: '',
                    images: []
                });
                const imageUrl = ref('');
                const repairRules = {
                    category: [{ required: true, message: '请选择故障类型', trigger: 'change' }],
                    room: [{ required: true, message: '请输入宿舍信息', trigger: 'blur' }],
                    description: [{ required: true, message: '请输入故障描述', trigger: 'blur' }],
                    appointment_time: [{ required: true, message: '请选择预约时间', trigger: 'change' }]
                };

                const handleImageUpload = async (options) => {
                    // 模拟图片上传
                    // 实际项目中应上传到后端并获取图片URL
                    setTimeout(() => {
                        options.onSuccess({ url: URL.createObjectURL(options.file) });
                    }, 1000);
                };

                const handleUploadSuccess = (response) => {
                    imageUrl.value = response.url;
                    repairForm.images.push(response.url);
                    ElMessage.success('图片上传成功');
                };

                const handleUploadError = () => {
                    ElMessage.error('图片上传失败');
                };

                const handleSubmit = async () => {
                    try {
                        await repairFormRef.value.validate();
                        // 提交报修单到后端
                        const response = await axios.post('/repairs', repairForm);
                        if (response.data.code === 200) {
                            ElMessage.success('报修提交成功');
                            resetForm();
                        } else {
                            ElMessage.error(response.data.msg);
                        }
                    } catch (error) {
                        ElMessage.error('提交失败');
                    }
                };

                const resetForm = () => {
                    repairFormRef.value.resetFields();
                    repairForm.images = [];
                    imageUrl.value = '';
                };

                return {
                    repairFormRef,
                    repairForm,
                    repairRules,
                    imageUrl,
                    handleImageUpload,
                    handleUploadSuccess,
                    handleUploadError,
                    handleSubmit,
                    resetForm
                };
            }
        };

        // 维修任务列表组件
        const RepairTasks = {
            template: `
                <div>
                    <el-card>
                        <template #header>
                            <div class="card-header">
                                <span>维修任务列表</span>
                            </div>
                        </template>
                        <el-table :data="tasks" style="width: 100%">
                            <el-table-column prop="id" label="报修单号" width="100"></el-table-column>
                            <el-table-column prop="room" label="宿舍信息" width="150"></el-table-column>
                            <el-table-column prop="description" label="故障描述"></el-table-column>
                            <el-table-column prop="category" label="故障类型" width="120"></el-table-column>
                            <el-table-column prop="status" label="状态" width="120">
                                <template #default="scope">
                                    <el-tag :type="getStatusType(scope.row.status)">{{ scope.row.status }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="created_at" label="创建时间" width="180"></el-table-column>
                            <el-table-column label="操作" width="180">
                                <template #default="scope">
                                    <el-button size="small" type="primary" @click="handleTakeTask(scope.row)">接受任务</el-button>
                                    <el-button size="small" @click="handleViewDetail(scope.row)">查看详情</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                </div>
            `,
            setup() {
                const tasks = ref([]);
                const loading = ref(false);
                
                onMounted(() => {
                    fetchTasks();
                });

                const fetchTasks = async () => {
                    loading.value = true;
                    try {
                        const response = await axios.get('/repairs');
                        if (response.data.code === 200) {
                            tasks.value = response.data.data;
                        }
                    } catch (error) {
                        ElMessage.error('获取任务列表失败');
                    } finally {
                        loading.value = false;
                    }
                };

                const getStatusType = (status) => {
                    switch (status) {
                        case 'pending': return 'warning';
                        case 'approved': return 'info';
                        case 'repairing': return 'primary';
                        case 'completed': return 'success';
                        case 'rejected': return 'danger';
                        default: return '';
                    }
                };

                const handleTakeTask = async (row) => {
                    try {
                        await ElMessageBox.confirm('确定要接受这个维修任务吗？', '接受任务', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        const response = await axios.put(`/repairs/${row.id}/accept`);
                        if (response.data.code === 200) {
                            row.status = 'repairing';
                            ElMessage.success('任务接受成功');
                        }
                    } catch (error) {
                        if (error.response) {
                            ElMessage.error(error.response.data.msg || '接受任务失败');
                        }
                        // 取消操作
                    }
                };

                const handleViewDetail = (row) => {
                    router.push(`/repair-detail/${row.id}`);
                };

                return {
                    tasks,
                    loading,
                    getStatusType,
                    handleTakeTask,
                    handleViewDetail
                };
            }
        };

        // 维修历史记录组件
        const RepairHistory = {
            template: `
                <div>
                    <el-card>
                        <template #header>
                            <div class="card-header">
                                <span>维修历史记录</span>
                            </div>
                        </template>
                        <el-table :data="history" style="width: 100%">
                            <el-table-column prop="id" label="报修单号" width="100"></el-table-column>
                            <el-table-column prop="room" label="宿舍信息" width="150"></el-table-column>
                            <el-table-column prop="description" label="故障描述"></el-table-column>
                            <el-table-column prop="category" label="故障类型" width="120"></el-table-column>
                            <el-table-column prop="status" label="状态" width="120">
                                <template #default="scope">
                                    <el-tag :type="getStatusType(scope.row.status)">{{ scope.row.status }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="completed_at" label="完成时间" width="180"></el-table-column>
                            <el-table-column prop="rating" label="满意度" width="100">
                                <template #default="scope">
                                    <el-rate v-model="scope.row.rating" disabled></el-rate>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作" width="100">
                                <template #default="scope">
                                    <el-button size="small" @click="handleViewDetail(scope.row)">查看详情</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                </div>
            `,
            setup() {
                const history = ref([
                    { id: 4, room: '4号楼201', description: '水龙头漏水', category: '水电', status: 'completed', completed_at: '2026-01-05 16:30:00', rating: 5 },
                    { id: 5, room: '5号楼302', description: '书桌抽屉损坏', category: '家具', status: 'completed', completed_at: '2026-01-05 15:15:00', rating: 4 },
                    { id: 6, room: '6号楼403', description: '窗户关不严', category: '门窗', status: 'completed', completed_at: '2026-01-05 14:20:00', rating: 3 }
                ]);

                const getStatusType = (status) => {
                    switch (status) {
                        case 'pending': return 'warning';
                        case 'approved': return 'info';
                        case 'repairing': return 'primary';
                        case 'completed': return 'success';
                        case 'rejected': return 'danger';
                        default: return '';
                    }
                };

                const handleViewDetail = (row) => {
                    ElMessage.info('查看详情功能待实现');
                };

                return {
                    history,
                    getStatusType,
                    handleViewDetail
                };
            }
        };

        // 我的报修组件
        const MyRepairs = {
            template: `
                <div>
                    <el-card>
                        <template #header>
                            <div class="card-header">
                                <span>我的报修记录</span>
                            </div>
                        </template>
                        <el-table :data="repairs" style="width: 100%">
                            <el-table-column prop="id" label="报修单号" width="100"></el-table-column>
                            <el-table-column prop="room" label="宿舍信息" width="150"></el-table-column>
                            <el-table-column prop="description" label="故障描述"></el-table-column>
                            <el-table-column prop="category" label="故障类型" width="120"></el-table-column>
                            <el-table-column prop="status" label="状态" width="120">
                                <template #default="scope">
                                    <el-tag :type="getStatusType(scope.row.status)">{{ scope.row.status }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="created_at" label="创建时间" width="180"></el-table-column>
                            <el-table-column prop="updated_at" label="更新时间" width="180"></el-table-column>
                            <el-table-column label="操作" width="120">
                                <template #default="scope">
                                    <el-button size="small" @click="handleViewDetail(scope.row)">查看详情</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                </div>
            `,
            setup() {
                const repairs = ref([]);
                const loading = ref(false);

                const getStatusType = (status) => {
                    switch (status) {
                        case 'pending': return 'warning';
                        case 'approved': return 'info';
                        case 'repairing': return 'primary';
                        case 'completed': return 'success';
                        case 'rejected': return 'danger';
                        default: return '';
                    }
                };

                const fetchRepairs = async () => {
                    loading.value = true;
                    try {
                        const response = await axios.get('/repairs');
                        if (response.data.code === 200) {
                            repairs.value = response.data.data;
                        }
                    } catch (error) {
                        ElMessage.error('获取报修记录失败');
                    } finally {
                        loading.value = false;
                    }
                };

                const handleViewDetail = (row) => {
                    router.push(`/repair-detail/${row.id}`);
                };

                onMounted(() => {
                    fetchRepairs();
                });

                return {
                    repairs,
                    loading,
                    getStatusType,
                    handleViewDetail
                };
            }
        };

        // 管理员报修管理组件
        const AdminRepairManagement = {
            template: `
                <div>
                    <el-card>
                        <template #header>
                            <div class="card-header">
                                <span>报修管理</span>
                            </div>
                        </template>
                        <el-table :data="repairs" style="width: 100%">
                            <el-table-column prop="id" label="报修单号" width="100"></el-table-column>
                            <el-table-column prop="student_name" label="学生姓名" width="120"></el-table-column>
                            <el-table-column prop="room" label="宿舍信息" width="150"></el-table-column>
                            <el-table-column prop="description" label="故障描述"></el-table-column>
                            <el-table-column prop="category" label="故障类型" width="120"></el-table-column>
                            <el-table-column prop="status" label="状态" width="120">
                                <template #default="scope">
                                    <el-tag :type="getStatusType(scope.row.status)">{{ scope.row.status }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="created_at" label="创建时间" width="180"></el-table-column>
                            <el-table-column label="操作" width="220">
                                <template #default="scope">
                                    <el-button size="small" type="success" @click="handleApprove(scope.row)" v-if="scope.row.status === 'pending'">审核通过</el-button>
                                    <el-button size="small" type="danger" @click="handleReject(scope.row)" v-if="scope.row.status === 'pending'">拒绝</el-button>
                                    <el-button size="small" @click="handleViewDetail(scope.row)">查看详情</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                </div>
            `,
            setup() {
                const repairs = ref([]);
                const loading = ref(false);

                const getStatusType = (status) => {
                    switch (status) {
                        case 'pending': return 'warning';
                        case 'approved': return 'info';
                        case 'repairing': return 'primary';
                        case 'completed': return 'success';
                        case 'rejected': return 'danger';
                        default: return '';
                    }
                };

                const fetchRepairs = async () => {
                    loading.value = true;
                    try {
                        const response = await axios.get('/repairs');
                        if (response.data.code === 200) {
                            repairs.value = response.data.data;
                        }
                    } catch (error) {
                        ElMessage.error('获取报修订单失败');
                    } finally {
                        loading.value = false;
                    }
                };

                const handleApprove = async (row) => {
                    try {
                        await ElMessageBox.confirm('确定要审核通过这个报修申请吗？', '审核通过', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'success'
                        });
                        
                        const response = await axios.put(`/repairs/${row.id}/approve`);
                        if (response.data.code === 200) {
                            row.status = 'approved';
                            ElMessage.success('审核通过成功');
                        }
                    } catch (error) {
                        if (error.response) {
                            ElMessage.error(error.response.data.msg || '审核通过失败');
                        }
                    }
                };

                const handleReject = async (row) => {
                    try {
                        await ElMessageBox.confirm('确定要拒绝这个报修申请吗？', '拒绝', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'danger'
                        });
                        
                        const response = await axios.put(`/repairs/${row.id}/reject`);
                        if (response.data.code === 200) {
                            row.status = 'rejected';
                            ElMessage.success('拒绝成功');
                        }
                    } catch (error) {
                        if (error.response) {
                            ElMessage.error(error.response.data.msg || '拒绝失败');
                        }
                    }
                };

                const handleViewDetail = (row) => {
                    router.push(`/repair-detail/${row.id}`);
                };

                onMounted(() => {
                    fetchRepairs();
                });

                return {
                    repairs,
                    loading,
                    getStatusType,
                    handleApprove,
                    handleReject,
                    handleViewDetail
                };
            }
        };

        // 管理员用户管理组件
        const AdminUserManagement = {
            template: `
                <div>
                    <el-card>
                        <template #header>
                            <div class="card-header">
                                <span>用户管理</span>
                                <el-button type="primary" style="float: right;" @click="handleAddUser">添加用户</el-button>
                            </div>
                        </template>
                        <el-table :data="users" style="width: 100%">
                            <el-table-column prop="id" label="ID" width="80"></el-table-column>
                            <el-table-column prop="username" label="账号" width="120"></el-table-column>
                            <el-table-column prop="name" label="姓名" width="120"></el-table-column>
                            <el-table-column prop="role" label="角色" width="120">
                                <template #default="scope">
                                    <el-tag :type="getRoleType(scope.row.role)">{{ scope.row.role }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="phone" label="手机号" width="150"></el-table-column>
                            <el-table-column prop="email" label="邮箱" width="200"></el-table-column>
                            <el-table-column prop="created_at" label="创建时间" width="180"></el-table-column>
                            <el-table-column label="操作" width="180">
                                <template #default="scope">
                                    <el-button size="small" type="primary" @click="handleEditUser(scope.row)">编辑</el-button>
                                    <el-button size="small" type="danger" @click="handleDeleteUser(scope.row)">删除</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>

                    <!-- 添加用户对话框 -->
                    <el-dialog
                        v-model="addDialogVisible"
                        title="添加用户"
                        width="500px"
                    >
                        <el-form :model="addUserForm" :rules="addUserRules" ref="addUserFormRef" label-width="100px">
                            <el-form-item label="账号" prop="username">
                                <el-input v-model="addUserForm.username" placeholder="请输入账号"></el-input>
                            </el-form-item>
                            <el-form-item label="密码" prop="password">
                                <el-input v-model="addUserForm.password" type="password" placeholder="请输入密码"></el-input>
                            </el-form-item>
                            <el-form-item label="姓名" prop="name">
                                <el-input v-model="addUserForm.name" placeholder="请输入姓名"></el-input>
                            </el-form-item>
                            <el-form-item label="角色" prop="role">
                                <el-select v-model="addUserForm.role" placeholder="请选择角色">
                                    <el-option label="学生" value="student"></el-option>
                                    <el-option label="维修人员" value="repairman"></el-option>
                                    <el-option label="管理员" value="admin"></el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="手机号" prop="phone">
                                <el-input v-model="addUserForm.phone" placeholder="请输入手机号"></el-input>
                            </el-form-item>
                            <el-form-item label="邮箱" prop="email">
                                <el-input v-model="addUserForm.email" placeholder="请输入邮箱"></el-input>
                            </el-form-item>
                        </el-form>
                        <template #footer>
                            <div class="dialog-footer">
                                <el-button @click="addDialogVisible = false">取消</el-button>
                                <el-button type="primary" @click="submitAddUser">确定</el-button>
                            </div>
                        </template>
                    </el-dialog>

                    <!-- 编辑用户对话框 -->
                    <el-dialog
                        v-model="editDialogVisible"
                        title="编辑用户"
                        width="500px"
                    >
                        <el-form :model="editUserForm" :rules="editUserRules" ref="editUserFormRef" label-width="100px">
                            <el-form-item label="账号" prop="username">
                                <el-input v-model="editUserForm.username" placeholder="请输入账号" disabled></el-input>
                            </el-form-item>
                            <el-form-item label="姓名" prop="name">
                                <el-input v-model="editUserForm.name" placeholder="请输入姓名"></el-input>
                            </el-form-item>
                            <el-form-item label="角色" prop="role">
                                <el-select v-model="editUserForm.role" placeholder="请选择角色">
                                    <el-option label="学生" value="student"></el-option>
                                    <el-option label="维修人员" value="repairman"></el-option>
                                    <el-option label="管理员" value="admin"></el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="手机号" prop="phone">
                                <el-input v-model="editUserForm.phone" placeholder="请输入手机号"></el-input>
                            </el-form-item>
                            <el-form-item label="邮箱" prop="email">
                                <el-input v-model="editUserForm.email" placeholder="请输入邮箱"></el-input>
                            </el-form-item>
                        </el-form>
                        <template #footer>
                            <div class="dialog-footer">
                                <el-button @click="editDialogVisible = false">取消</el-button>
                                <el-button type="primary" @click="submitEditUser">确定</el-button>
                            </div>
                        </template>
                    </el-dialog>
                </div>
            `,
            setup() {
                const users = ref([]);
                const loading = ref(false);
                const addDialogVisible = ref(false);
                const editDialogVisible = ref(false);
                const addUserFormRef = ref(null);
                const editUserFormRef = ref(null);

                const addUserForm = reactive({
                    username: '',
                    password: '',
                    name: '',
                    role: '',
                    phone: '',
                    email: ''
                });

                const editUserForm = reactive({
                    id: '',
                    username: '',
                    name: '',
                    role: '',
                    phone: '',
                    email: ''
                });

                const addUserRules = {
                    username: [{ required: true, message: '请输入账号', trigger: 'blur' }],
                    password: [{ required: true, message: '请输入密码', trigger: 'blur' }],
                    name: [{ required: true, message: '请输入姓名', trigger: 'blur' }],
                    role: [{ required: true, message: '请选择角色', trigger: 'change' }]
                };

                const editUserRules = {
                    name: [{ required: true, message: '请输入姓名', trigger: 'blur' }],
                    role: [{ required: true, message: '请选择角色', trigger: 'change' }]
                };

                const getRoleType = (role) => {
                    switch (role) {
                        case 'admin': return 'danger';
                        case 'student': return 'success';
                        case 'repairman': return 'primary';
                        default: return '';
                    }
                };

                const fetchUsers = async () => {
                    loading.value = true;
                    try {
                        const response = await axios.get('/users');
                        if (response.data.code === 200) {
                            users.value = response.data.data;
                        }
                    } catch (error) {
                        ElMessage.error('获取用户列表失败');
                    } finally {
                        loading.value = false;
                    }
                };

                const handleAddUser = () => {
                    Object.keys(addUserForm).forEach(key => {
                        addUserForm[key] = '';
                    });
                    addDialogVisible.value = true;
                };

                const submitAddUser = async () => {
                    try {
                        await addUserFormRef.value.validate();
                        const response = await axios.post('/users', addUserForm);
                        if (response.data.code === 200) {
                            ElMessage.success('添加用户成功');
                            addDialogVisible.value = false;
                            fetchUsers();
                        }
                    } catch (error) {
                        if (error.response) {
                            ElMessage.error(error.response.data.msg || '添加用户失败');
                        }
                    }
                };

                const handleEditUser = (row) => {
                    Object.assign(editUserForm, row);
                    editDialogVisible.value = true;
                };

                const submitEditUser = async () => {
                    try {
                        await editUserFormRef.value.validate();
                        const response = await axios.put(`/users/${editUserForm.id}`, {
                            name: editUserForm.name,
                            role: editUserForm.role,
                            phone: editUserForm.phone,
                            email: editUserForm.email
                        });
                        if (response.data.code === 200) {
                            ElMessage.success('编辑用户成功');
                            editDialogVisible.value = false;
                            fetchUsers();
                        }
                    } catch (error) {
                        if (error.response) {
                            ElMessage.error(error.response.data.msg || '编辑用户失败');
                        }
                    }
                };

                const handleDeleteUser = async (row) => {
                    try {
                        await ElMessageBox.confirm('确定要删除这个用户吗？', '删除用户', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'danger'
                        });
                        const response = await axios.delete(`/users/${row.id}`);
                        if (response.data.code === 200) {
                            ElMessage.success('删除成功');
                            fetchUsers();
                        }
                    } catch (error) {
                        if (error.response) {
                            ElMessage.error(error.response.data.msg || '删除失败');
                        }
                    }
                };

                onMounted(() => {
                    fetchUsers();
                });

                return {
                    users,
                    loading,
                    addDialogVisible,
                    editDialogVisible,
                    addUserFormRef,
                    editUserFormRef,
                    addUserForm,
                    editUserForm,
                    addUserRules,
                    editUserRules,
                    getRoleType,
                    handleAddUser,
                    submitAddUser,
                    handleEditUser,
                    submitEditUser,
                    handleDeleteUser
                };
            }
        };

        // 管理员公告管理组件
        const AdminNoticeManagement = {
            template: `
                <div>
                    <el-card>
                        <template #header>
                            <div class="card-header">
                                <span>公告管理</span>
                                <el-button type="primary" style="float: right;" @click="handleAddNotice">发布公告</el-button>
                            </div>
                        </template>
                        <el-table :data="notices" style="width: 100%">
                            <el-table-column prop="id" label="ID" width="80"></el-table-column>
                            <el-table-column prop="title" label="标题" width="300"></el-table-column>
                            <el-table-column prop="author_name" label="发布人" width="120"></el-table-column>
                            <el-table-column prop="created_at" label="发布时间" width="180"></el-table-column>
                            <el-table-column label="操作" width="180">
                                <template #default="scope">
                                    <el-button size="small" type="primary" @click="handleEditNotice(scope.row)">编辑</el-button>
                                    <el-button size="small" type="danger" @click="handleDeleteNotice(scope.row)">删除</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                </div>
            `,
            setup() {
                const notices = ref([
                    { id: 1, title: '关于宿舍报修系统上线的通知', content: '系统将于2026年1月1日正式上线', author_name: '系统管理员', created_at: '2026-01-01 00:00:00' },
                    { id: 2, title: '维修时间调整通知', content: '维修时间调整为周一至周五 8:00-18:00', author_name: '系统管理员', created_at: '2026-01-02 10:00:00' }
                ]);

                const handleAddNotice = () => {
                    ElMessage.info('发布公告功能待实现');
                };

                const handleEditNotice = (row) => {
                    ElMessage.info('编辑公告功能待实现');
                };

                const handleDeleteNotice = (row) => {
                    ElMessageBox.confirm('确定要删除这个公告吗？', '删除公告', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'danger'
                    }).then(() => {
                        const index = notices.value.findIndex(notice => notice.id === row.id);
                        if (index !== -1) {
                            notices.value.splice(index, 1);
                            ElMessage.success('删除成功');
                        }
                    }).catch(() => {
                        // 取消操作
                    });
                };

                return {
                    notices,
                    handleAddNotice,
                    handleEditNotice,
                    handleDeleteNotice
                };
            }
        };

        // 个人中心组件
        const Profile = {
            template: `
                <div>
                    <el-card>
                        <template #header>
                            <div class="card-header">
                                <span>个人中心</span>
                            </div>
                        </template>
                        <div class="profile-container">
                            <div class="profile-info">
                                <el-avatar :size="100" :src="userStore.userInfo.avatar || ''"></el-avatar>
                                <div class="profile-details">
                                    <h3>{{ userStore.userInfo.name }}</h3>
                                    <p><strong>账号：</strong>{{ userStore.userInfo.username }}</p>
                                    <p><strong>角色：</strong>{{ userStore.userInfo.role }}</p>
                                    <p><strong>手机号：</strong>{{ userStore.userInfo.phone || '未设置' }}</p>
                                    <p><strong>邮箱：</strong>{{ userStore.userInfo.email || '未设置' }}</p>
                                </div>
                            </div>
                            <el-divider></el-divider>
                            <el-button type="primary" @click="handleEditProfile">编辑个人信息</el-button>
                            <el-button type="warning" @click="handleChangePassword">修改密码</el-button>
                        </div>
                    </el-card>
                </div>
            `,
            setup() {
                const userStore = useUserStore();

                const handleEditProfile = () => {
                    ElMessage.info('编辑个人信息功能待实现');
                };

                const handleChangePassword = () => {
                    ElMessage.info('修改密码功能待实现');
                };

                return {
                    userStore,
                    handleEditProfile,
                    handleChangePassword
                };
            }
        };

        // 公告列表组件
        const Notices = {
            template: `
                <div>
                    <el-card>
                        <template #header>
                            <div class="card-header">
                                <span>公告列表</span>
                            </div>
                        </template>
                        <div class="notices-list">
                            <div v-for="notice in notices" :key="notice.id" class="notice-item">
                                <h4 class="notice-title">{{ notice.title }}</h4>
                                <p class="notice-meta">发布人：{{ notice.author_name }} | 发布时间：{{ notice.created_at }}</p>
                                <p class="notice-content">{{ notice.content }}</p>
                                <el-divider></el-divider>
                            </div>
                        </div>
                    </el-card>
                </div>
            `,
            setup() {
                const notices = ref([
                    { id: 1, title: '关于宿舍报修系统上线的通知', content: '系统将于2026年1月1日正式上线，欢迎大家使用在线报修功能。', author_name: '系统管理员', created_at: '2026-01-01 00:00:00' },
                    { id: 2, title: '维修时间调整通知', content: '维修时间调整为周一至周五 8:00-18:00，请同学们合理安排报修时间。', author_name: '系统管理员', created_at: '2026-01-02 10:00:00' }
                ]);

                return {
                    notices
                };
            }
        };

        // 添加样式
        const style = document.createElement('style');
        style.textContent = `
            .profile-container {
                padding: 20px;
            }
            .profile-info {
                display: flex;
                align-items: center;
                margin-bottom: 30px;
            }
            .profile-details {
                margin-left: 30px;
            }
            .profile-details p {
                margin: 5px 0;
            }
            .notices-list {
                padding: 10px;
            }
            .notice-item {
                margin-bottom: 20px;
            }
            .notice-title {
                margin: 0 0 10px 0;
                font-size: 18px;
                color: #333;
            }
            .notice-meta {
                margin: 0 0 10px 0;
                font-size: 14px;
                color: #999;
            }
            .notice-content {
                margin: 0;
                font-size: 16px;
                line-height: 1.6;
            }
        `;
        document.head.appendChild(style);

        // 路由配置
        const routes = [
            { path: '/login', component: Login },
            {
                path: '/',
                component: Layout,
                children: [
                    { path: '', component: Home },
                    { path: 'repair', component: Repair, meta: { requiresAuth: true, roles: ['student'] } },
                    { path: 'my-repairs', component: MyRepairs, meta: { requiresAuth: true, roles: ['student'] } },
                    { path: 'repair-tasks', component: RepairTasks, meta: { requiresAuth: true, roles: ['repairman'] } },
                    { path: 'repair-history', component: RepairHistory, meta: { requiresAuth: true, roles: ['repairman'] } },
                    { path: 'admin/repair-management', component: AdminRepairManagement, meta: { requiresAuth: true, roles: ['admin'] } },
                    { path: 'admin/user-management', component: AdminUserManagement, meta: { requiresAuth: true, roles: ['admin'] } },
                    { path: 'admin/data-dashboard', component: DataDashboard, meta: { requiresAuth: true, roles: ['admin'] } },
                    { path: 'admin/notice-management', component: AdminNoticeManagement, meta: { requiresAuth: true, roles: ['admin'] } },
                    { path: 'profile', component: Profile, meta: { requiresAuth: true } },
                    { path: 'notices', component: Notices, meta: { requiresAuth: true } }
                ]
            }
        ];

        // 创建路由实例
        const router = createRouter({
            history: createWebHashHistory(),
            routes
        });

        // 路由守卫
        router.beforeEach((to, from, next) => {
            const userStore = useUserStore();
            
            // 如果是登录页面，直接通过
            if (to.path === '/login') {
                next();
                return;
            }
            
            // 非登录页面需要验证登录状态
            if (!userStore.isLoggedIn) {
                next('/login');
                return;
            }
            
            // 验证角色权限
            if (to.meta.roles && !to.meta.roles.includes(userStore.userInfo.role)) {
                ElMessage.error('没有权限访问该页面');
                next('/');
                return;
            }
            
            next();
        });

        // 创建应用实例
        const app = createApp({});

        // 使用插件
        app.use(router);
        app.use(ElementPlus);

        // 挂载应用
        app.mount('#app');
    </script>
</body>
</html>